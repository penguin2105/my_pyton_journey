from telegram import Update, ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext, CallbackQueryHandler
import random

TOKEN = "7814951497:AAHM4Gg_PwhCjZQJ3aNltWjniCWfmCOJRPY"

def start(update: Update, context: CallbackContext) -> None:
    user = update.effective_user
    update.message.reply_text(
        f"ÐŸÑ€Ð¸Ð²ÐµÑ‚, {user.first_name}! Ð¯ ÐšÐ¾ÑÑ‚Ñ Ñ€Ð²Ð°Ð½Ð½Ñ‹Ðµ ÐºÐ¾Ð»Ð³Ð¾Ñ‚ÐºÐ¸ Ñ ÐºÐ½Ð¾Ð¿ÐºÐ°Ð¼Ð¸.\n"
        "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ /help Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑƒÐ²Ð¸Ð´ÐµÑ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹."
    )
    show_main_keyboard("help_text")

    

def help_command(update: Update, context: CallbackContext) -> None:
    help_text = """
    Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:
    /start - ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ ÐšÐ¾ÑÑ‚ÐµÐ¹
    /help - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒ
    /menu - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¼ÐµÐ½ÑŽ
    /info - Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ
    /game - Ð˜Ð³Ñ€Ð°Ñ‚ÑŒ Ð² 'Ð£Ð³Ð°Ð´Ð°Ð¹ Ñ‡Ð¸ÑÐ»Ð¾' (1-100)
    /stop - Ð¡Ð´Ð°Ñ‚ÑŒÑÑ Ð¸ Ð·Ð°ÐºÐ¾Ð½Ñ‡Ð¸Ñ‚ÑŒ Ð¸Ð³Ñ€Ñƒ
    
    Ð¢Ð°ÐºÐ¶Ðµ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð½Ð¸Ð¶Ðµ!
    """
    update.message.reply_text(help_text)


        
def info(update: Update, context: CallbackContext) -> None:
    update.message.reply_text("Ð¯ Ðº.ÑŽ Ñ€Ð²Ð°Ð» Ñ‚Ð²Ð¾ÑŽ Ð¶Ð¾Ð¿Ñƒ Ð´Ð°Ð²Ð°Ð¹ Ð²Ñ‹Ð±ÐµÑ€Ð¸ Ð¿ÑƒÐ½ÐºÑ‚Ñ‹.\nÐÐµÑÑ‚ÐµÑÐ½ÑÐ¹ÑÑ Ñ Ð½ÐµÑ„Ð¾Ñ€.")

def start_game(update: Update, context: CallbackContext) -> None:
    secret_number = random.randint(1, 100)
    context.user_data['game_active'] = True
    context.user_data['secret_number'] = secret_number
    context.user_data['attempts'] = 0
    update.message.reply_text(
        "ðŸŽ® Ð˜Ð³Ñ€Ð° 'Ð£Ð³Ð°Ð´Ð°Ð¹ Ñ‡Ð¸ÑÐ»Ð¾'!\n"
        "Ð•Ð±Ð°Ñˆ Ñ‡Ð¸ÑÐ»Ð¾ Ð¾Ñ‚ 1 Ð´Ð¾ 100. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ ÑƒÐ³Ð°Ð´Ð°Ñ‚ÑŒ!\n"
        "Ð§Ñ‚Ð¾Ð±Ñ‹ ÑÐ´Ð°Ñ‚ÑŒÑÑ, Ð½Ð°Ð¿Ð¸ÑˆÐ¸ /stop."
    )

def guess_number(update: Update, context: CallbackContext) -> None:
    if context.user_data.get('game_active'):
        try:
            user_guess = int(update.message.text)
            secret_number = context.user_data['secret_number']
            context.user_data['attempts'] += 1

            if user_guess < 1 or user_guess > 200:
                update.message.reply_text("ðŸš« ÐŸÑ€Ð¾Ð²Ð¾Ð´ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ñ‚ 1 Ð´Ð¾ 200Ð¼Ð¼!")
            elif user_guess < secret_number:
                update.message.reply_text("â¬†ï¸ ÐÐ¸Ñ…ÑƒÑ Ð½Ðµ Ð¾Ñ‚Ð³Ð°Ð´Ð°Ð» Ð¡ÐµÑ€ÐµÐ¶Ð° Ð±ÑƒÐ´ÐµÑ‚ Ð½ÐµÐ´Ð¾Ð²Ð¾Ð»ÐµÐ½!")
            elif user_guess > secret_number:
                update.message.reply_text("â¬‡ï¸ ÐÐ°Ñ…ÑƒÐ¹ ÑÑ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¼Ð°Ð»Ð¾!")
            else:
                attempts = context.user_data['attempts']
                update.message.reply_text(f"ðŸŽ‰ Ð•Ð±Ð°Ñ‚ÑŒ Ñ‚Ñ‹ Ð¼Ð¾Ð»Ð¾Ð´ÐµÑ†! Ð£Ð³Ð°Ð´Ð°Ð» Ð·Ð° {attempts} Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº!")
                context.user_data.clear()
        except ValueError:
            update.message.reply_text("ðŸ”¢ Ð•Ð±Ð°Ñˆ Ñ‚Ð¾ Ð¼Ñ‹ Ñ ÑÐµÑ€ÐµÐ¶Ð¾Ð¹ Ð¾Ð±Ð¸Ð´ÐµÐ¼ÑÑ Ð¾Ñ‚ 1 Ð´Ð¾ 200!")
    else:
        button_click(update, context)

def stop_game(update: Update, context: CallbackContext) -> None:
    if 'secret_number' in context.user_data:
        secret_number = context.user_data['secret_number']
        update.message.reply_text(
            f"ðŸ˜¥ ÐÐ¸Ñ…ÑƒÑ Ñ‚Ñ‹ Ñ‚Ð¸Ð¿Ð¾ {secret_number}.\n"
            "Ð•ÑÐ»Ð¸ Ñ…Ð¾Ñ‡ÐµÑˆÑŒ Ð¼ÐµÐ½Ñ Ð·Ð°ÐµÐ±Ð°Ñ‚ÑŒ ÐµÐ±Ð°Ñˆ /game."
        )
        context.user_data.clear()

def show_main_keyboard(update: Update, context: CallbackContext) -> None:
    keyboard = [
        [KeyboardButton("ÐšÐ¾Ð¼Ð½Ð°Ñ‚Ð°  1"), KeyboardButton("ÐšÐ¾Ð¼Ð½Ð°Ñ‚Ð° 2")],
        [KeyboardButton("Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸"), KeyboardButton("ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ")],
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    update.message.reply_text("Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ:", reply_markup=reply_markup)

def button_click(update: Update, context: CallbackContext) -> None:
    text = update.message.text
    if text == "ÐšÐ½Ð¾Ð¿ÐºÐ° 1":
        update.message.reply_text("Ð›ÐµÑˆÐ° Ñ‚Ñ‹ Ð¿Ñ€Ð¸Ð½ÑÐ» Ð­Ð»ÐµÐºÑ‚Ñ€Ð¾ ÑÐ¿Ð±!")
    elif text == "ÐšÐ½Ð¾Ð¿ÐºÐ° 2":
        update.message.reply_text("Ð›ÐµÑˆÐ° Ð³Ð´Ðµ Ð¿Ñ€Ð¾Ð²Ð¾Ð´Ð°!")
    elif text == "Ð˜Ð½Ð»Ð°Ð¹Ð½ ÐºÐ½Ð¾Ð¿ÐºÐ¸":
        show_inline_keyboard(update, context)
    elif text == "ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ":
        help_command(update, context)

def show_inline_keyboard(update: Update, context: CallbackContext) -> None:
    keyboard = [
        [InlineKeyboardButton("ÐžÐ¿Ñ†Ð¸Ñ 1", callback_data='option1')],
        [InlineKeyboardButton("ÐžÐ¿Ñ†Ð¸Ñ 2", callback_data='option2')],
        [InlineKeyboardButton("Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ", callback_data='close')],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    update.message.reply_text("Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¾Ð¿Ñ†Ð¸ÑŽ:", reply_markup=reply_markup)

def inline_button(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    query.answer()
    
    if query.data == 'option1':
        query.edit_message_text(text="Ð“Ð´Ðµ Ð¿Ñ€Ð¾Ð²Ð¾Ð´Ð°")
    elif query.data == 'option2':
        query.edit_message_text(text="Ð¯ Ð½Ð° Ð¼Ð¾Ñ€Ðµ Ð¶Ð¾Ð¿Ñƒ Ð·Ð°Ð³Ð¾Ñ€Ð°ÑŽ Ð´Ð»Ñ Ð’Ð°Ð½Ð¸")
    elif query.data == 'close':
        query.edit_message_text(text="ÐŸÐ¾ÑˆÐ»Ð¸ Ð¾Ñ‚ÑÑŽÐ´Ð°")

def main() -> None:
    updater = Updater("7814951497:AAHM4Gg_PwhCjZQJ3aNltWjniCWfmCOJRPY")
    dispatcher = updater.dispatcher

    dispatcher.add_handler(CommandHandler("start", start))
    dispatcher.add_handler(CommandHandler("help", help_command))
    dispatcher.add_handler(CommandHandler("info", info))
    dispatcher.add_handler(CommandHandler("menu", show_main_keyboard))
    dispatcher.add_handler(CommandHandler("game", start_game))
    dispatcher.add_handler(CommandHandler("stop", stop_game))

    dispatcher.add_handler(MessageHandler(Filters.text & ~Filters.command, guess_number))
    dispatcher.add_handler(CallbackQueryHandler(inline_button))

    updater.start_polling()
    updater.idle()

if __name__ == '__main__':
    main()
